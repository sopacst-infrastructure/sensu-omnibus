<?xml version='1.0'?>
<Wix
    xmlns="http://schemas.microsoft.com/wix/2006/wi"
    xmlns:util="http://schemas.microsoft.com/wix/UtilExtension"
    xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension"
>

  <!-- This is how we include wxi files -->
  <?include "parameters.wxi" ?>

  <!--
    Id="*" is to enable upgrading. * means that the product ID will be autogenerated on each build.
    Name is made of localized product name and version number.
  -->
  <Product Id="*" Name="!(loc.ProductName)" Language="!(loc.LANG)"
           Version="$(var.VersionNumber)" Manufacturer="!(loc.ManufacturerName)" UpgradeCode="$(var.UpgradeCode)">

    <!--
      Minimum installer version (2.0) - Window XP and above.
      The install scope is per machine, not the current user
    -->
    <Package InstallerVersion="200" InstallPrivileges="elevated"
             Compressed="yes" InstallScope="perMachine" />

    <!-- Include .NET Framework properties -->
    <PropertyRef Id="NETFRAMEWORK20"/>
    <PropertyRef Id="WIX_IS_NETFRAMEWORK_40_OR_LATER_INSTALLED"/>

    <Media Id="1" Cabinet="Project.cab" EmbedCab="yes" CompressionLevel="high" />

    <!--
      Uncomment launch condition below to check for minimum OS
      601 = Windows 7/Server 2008R2.
    -->
    <!-- Condition Message="!(loc.MinimumOSVersionMessage)">
      <![CDATA[Installed OR VersionNT >= 601]]>
    </Condition -->

    <Condition Message="This application requires .NET Framework 2.0 or newer. Please install the .NET Framework then run this installer again.">
      <![CDATA[Installed OR NETFRAMEWORK20 OR WIX_IS_NETFRAMEWORK_40_OR_LATER_INSTALLED]]>
    </Condition>

    <!-- Major upgrade -->
    <Upgrade Id="$(var.UpgradeCode)">
      <UpgradeVersion OnlyDetect="yes" Minimum="$(var.VersionNumber)" IncludeMinimum="no" Property="NEWERVERSIONDETECTED" />
      <UpgradeVersion Minimum="0.0.0.0" IncludeMinimum="yes" Maximum="$(var.VersionNumber)" IncludeMaximum="no" Property="OLDERVERSIONBEINGUPGRADED" />
    </Upgrade>

    <!--
      If fastmsi is set, custom actions will be invoked during install to unzip
      project files, and during uninstall to remove the project folder
    -->
    <% if fastmsi %>
    <SetProperty Id="FastUnzip"
                 Value="FASTZIPDIR=[INSTALLLOCATION];FASTZIPAPPNAME=sensu"
                 Sequence="execute"
                 Before="FastUnzip" />

    <CustomAction Id="FastUnzip"
                  BinaryKey="CustomActionFastMsiDLL"
                  DllEntry="FastUnzip"
                  Execute="deferred"
                  Return="check" />

    <Binary Id="CustomActionFastMsiDLL"
            SourceFile="CustomActionFastMsi.CA.dll" />

    <CustomAction Id="Cleanup"
                  Directory="INSTALLLOCATION"
                  ExeCommand="cmd /C &quot;rd /S /Q sensu&quot;"
                  Execute="deferred"
                  Return="ignore" />

    <InstallExecuteSequence>
      <Custom Action="FastUnzip" After="InstallFiles">NOT Installed</Custom>
      <Custom Action="Cleanup" After="RemoveFiles">REMOVE~="ALL"</Custom>
      <RemoveExistingProducts After="InstallValidate" />
    </InstallExecuteSequence>

    <UI>
      <ProgressText Action="FastUnzip">!(loc.FileExtractionProgress)</ProgressText>
    </UI>
    <% else %>
    <InstallExecuteSequence>
      <RemoveExistingProducts After="InstallValidate" />
    </InstallExecuteSequence>
    <% end %>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="WINDOWSVOLUME">
<% hierarchy.each.with_index do |(name, id), index| -%>
        <%= '  '*index %><Directory Id="<%= id %>" Name="<%= name %>">
<% end -%>
<% hierarchy.keys.each.with_index do |_, index| -%>
        <%= '  '*(hierarchy.size - index-1) %></Directory>
<% end -%>
      </Directory>
    </Directory>

    <DirectoryRef Id="PROJECTLOCATION">
      <Component Id="SensuPath"
                 Guid="{60098D5D-BBA4-41C6-8F6F-DA600AB4834B}" >
        <Environment Id="Environment" Name="PATH" Action="set"
                     Part="last" System="yes"
                     Value="[PROJECTLOCATION]bin;[PROJECTLOCATION]embedded\bin" />
      </Component>
      <Component Id="SensuServiceWrapperNET4"
                 Guid="{60098D5D-BBA4-41C6-8F6F-DA600CC4834C}">
        <Condition>
          WIX_IS_NETFRAMEWORK_40_OR_LATER_INSTALLED
        </Condition>
        <CopyFile Id="CopySensuServiceWrapperNET4"
                  FileId="fil2730CA0415D63723292B43F1184FB6DC"
                  DestinationDirectory="dirAACB971AAE53CD846725B5E3EF1FFD5C" DestinationName="sensu-client.exe" />
      </Component>
      <Component Id="SensuServiceWrapperNET2"
                 Guid="{60098D5D-BBA4-41C6-8F6F-DA600DD4834D}">
        <Condition>
          NETFRAMEWORK20 AND NOT WIX_IS_NETFRAMEWORK_40_OR_LATER_INSTALLED
        </Condition>
        <CopyFile Id="CopySensuServiceWrapperNET2"
                  FileId="fil21EAF549C118E62490D5F1CA8D307009"
                  DestinationDirectory="dirAACB971AAE53CD846725B5E3EF1FFD5C" DestinationName="sensu-client.exe" />
      </Component>
    </DirectoryRef>

    <SetDirectory Id="WINDOWSVOLUME" Value="[WindowsVolume]" />

    <!-- Set the components defined in our fragment files that will be used for our feature  -->
    <Feature Id="ProjectFeature" Title="!(loc.FeatureMainName)" Absent="disallow" AllowAdvertise="no" Level="1" ConfigurableDirectory="<%= wix_install_dir %>">
      <ComponentGroupRef Id="ProjectDir" />
      <ComponentRef Id="SensuPath" />
      <ComponentRef Id="SensuServiceWrapperNET4" />
      <ComponentRef Id="SensuServiceWrapperNET2" />
    </Feature>

    <!-- UI Stuff -->
    <Icon Id="project.ico" SourceFile="Resources\assets\project_16x16.ico"/>
    <Property Id="ARPPRODUCTICON" Value="project.ico" />
    <Property Id="ARPHELPLINK" Value="https://www.sensuapp.org/" />
    <Property Id="WIXUI_INSTALLDIR" Value="<%= wix_install_dir %>" />

    <UIRef Id="ProjectUI_InstallDir"/>
    <UI Id="ProjectUI_InstallDir">
      <UIRef Id="WixUI_FeatureTree"/>
      <TextStyle Id="WixUI_Font_Normal_White" FaceName="Tahoma" Size="8" Red="255" Green="255" Blue="255" />
      <TextStyle Id="WixUI_Font_Bigger_White" FaceName="Tahoma" Size="12" Red="255" Green="255" Blue="255" />
      <TextStyle Id="WixUI_Font_Title_White" FaceName="Tahoma" Size="9" Bold="yes" Red="255" Green="255" Blue="255" />
    </UI>

    <WixVariable Id="WixUILicenseRtf" Value="Resources\assets\LICENSE.rtf" />
    <WixVariable Id="WixUIDialogBmp" Value="Resources\assets\dialog_background.bmp" />
    <WixVariable Id="WixUIBannerBmp" Value="Resources\assets\banner_background.bmp" />

    <WixVariable Id="WixUIExclamationIco" Value="Resources\assets\project_32x32.ico" />
    <WixVariable Id="WixUIInfoIco" Value="Resources\assets\project_32x32.ico" />
    <WixVariable Id="WixUINewIco" Value="Resources\assets\project_16x16.ico" />
    <WixVariable Id="WixUIUpIco" Value="Resources\assets\project_16x16.ico" />
  </Product>
</Wix>
